---
title: ""
aliases: []
id: alphabeta-sim-tros01
tags: []

execute:
  echo: false
  warning: false
jupyter: julia-1.12
---
{{<pagebreak>}}

Tohle je ta část, kde to začalo být zajímavé. A taky frustrující. Měl jsem za úkol vyřešit koncovku **2 králové proti 1 králi**. Zní to jako jasná věc, ne? Máte přesilu, prostě ho umlátíte. Jenže donutit deterministický algoritmus, aby soupeře skutečně *hnal* do rohu a ne jenom tančil kolem něj, se ukázalo jako docela solidní oříšek.

Cílem bylo postavit agenta, který nejen že vyhraje, ale vyhraje **efektivně** a spolehlivě. Žádné náhodné poťouchlosti, ale čistá strojová dominance.

**Vizualizace herního stromu (Obrázek `\ref{fig-assignment}`{=latex} na titulní straně)**

Na titulním obrázku (Obrázek `\ref{fig-assignment}`{=latex}) je vidět, jak jsem ten problém vlastně řešil, tedy alespoň z počátku. 

Je to klasický Minimax s Alpha-Beta ořezáváním, ale v praxi to vypadá spíš jako prohledávání obrovského stromu možností:
- **MAX uzly**: To jsem já, snažím se urvat co nejvíc bodů.
- **MIN uzly**: To je soupeř, snaží se mi to zkazit.
- **Ořezávání (Pruning)**: To jsou ty šedé větve. Vizualizovat celý strom bez prořezání by v tomhle měřítku nedávalo smysl – jak ukazují moje testy (`tests.md`), i pro jednoduché stavy generuje hrubá síla tisíce uzlů (např. 2090 vs 0 pro manuální cestu). Byl by to jen jeden velký nepřehledný "blob".
- **Minimalizace**: Proto zde ukazuji **pouze nezbytné minimum** – kritickou cestu (Principal Variation), kterou jsem identifikoval během manuální analýzy jako vítěznou. Vše ostatní je šum, který nás v tuto chvíli nezajímá. Neukazujeme "prohledávání", ukazujeme "řešení".

## Klíčové momenty a Strategie

Tady jsem sepsal věci, na které jsem přišel metodou pokus-omyl (hodně omylů). Abych tu hru dohrál, musel jsem pochopit, jak se ty kameny vlastně mají chovat.

### Proč manuální simulace?
Možná se ptáte, proč jsem prostě nepustil 10 000 automatických her a neanalyzoval logy. Odpověď je jednoduchá: **Intuice**.
Když koukáte na logy ve formátu `Score: 4120, Move: 14-9`, nevidíte *proč* se to děje. Nevidíte tu frustraci, když agent sice neprohraje, ale 50 tahů jenom chodí tam a zpátky.
Musel jsem si tu hru "ohmatat". Vzít figurky (nebo myš v simulátoru), zkusit hrát za toho "hloupého" soupeře a zjistit, kde má můj agent slabiny. Jedině tak jsem pochopil, že mi chybí koncept "pasti" nebo "kotvy".

### Strategické imperativy

1.  **2 na 1 je nutnost**: Přijít o jednoho krále znamená remízu. Game over. Takže výměny jsou absolutní tabu.
2.  **Vytlačit z centra**: Soupeř se chce držet uprostřed (tam má nejvíc možností). Já ho musím narvat do rohu jak do pytle.
3.  **Past (The Net)**: Nestačí ho jen tlačit. Musím kolem něj utáhnout smyčku. Spolupráce obou mých králů je klíčová.

### Role králů: Kotva a Operátor

Tohle byl asi největší "aha moment". Moji králové nemůžou dělat to samé. Musí si rozdělit role:
-   **Kotva (The Anchor)**: Jeden stojí a hlídá ústupovou cestu (kempí).
-   **Operátor (The Operator)**: Druhý aktivně doráží a zmenšuje soupeři manévrovací prostor.

Když se snažili oba dorážet najednou, akorát si překáželi.

***

## Detailní rozbor heuristiky (Periodic Blocks)

Tady rozeberu, jak jsem tyhle myšlenky přetavil do kódu. Každou část heuristiky jsem si musel obhájit, nasimulovat a vyladit.

### 1. Materiál a Bezpečnost (1v1 Protection)

#### Požadavek
Zabránit za každou cenu výměně, která by vedla k remíze (1 vs 1).

#### Diskuze
V běžné střední hře je výměna 1:1 přijatelná. V koncovce 2:1 je to fatální chyba. Heuristika musí vnímat stav 1:1 jako "zakázaný" (loss condition).

#### Matematika
$$
h_{material} = \begin{cases} 
-\infty & \text{pokud } N_{my}=1 \land N_{opp}=1 \\
w_{mat} \cdot (N_{my} - N_{opp}) & \text{jinak}
\end{cases}
$$

#### Analýza limitů a extrémů
- **Extrém (Loss Condition):** Pokud $N_{my} \to 1$, funkce okamžitě padá do $-\infty$. Toto není soft-limit, ale hard-constraint. Algoritmus raději obětuje cokoliv jiného, než aby dopustil tento stav.
- **Běžný stav:** V drtivé většině času je hodnota konstantní ($300+300-300 = 300$). Materiál v koncovce 2v1 nerozhoduje, rozhoduje pozice.


#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_1v1" dedent="true"}
```

### 2. Pozice a Kontrola (Red Position)

#### Požadavek
Donutit soupeře opustit bezpečné "dvojité rohy" (pole 1, 5, 28, 32).

#### Diskuze
Červený král v rohu je v bezpečí. Nemůžeme ho vyhodit, pokud neudělá chybu. Musíme ho aktivně "vytlačit" nebo "vykouřit" tím, že mu obsadíme sousední pole a donutíme ho k tahu (tzv. *zugzwang*).

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_red_pos" dedent="true"}
```

1. Penalta: Červený v bezpečné zóně (dvojitý roh) — agent ho chce vytlačit.
2. Bonus: Červený opustil bezpečí — úspěšné vytlačení.

### 3. Koordinace (Coordination & Squeeze)

#### Požadavek
Králové musí spolupracovat. Jeden sám nic nezmůže.

#### Diskuze
Zavedli jsme koncept "optimální vzdálenosti". Pokud jsou naši králové příliš daleko od sebe (>6 polí), nemohou si krýt záda. Pokud jsou příliš blízko (1 pole), překážejí si. Ideální vzdálenost je 2-4 pole.

#### Matematika
Heuristika uděluje bonus $w_{coord}$, pokud:
$$ 2 \le dist(K_1, K_2) \le 4 $$

#### Analýza limitů a extrémů
- **Dolní extrém ($dist < 2$):** Pokud se králové "lepí" na sebe ($dist=1$), překážejí si v pohybu. Funkce toto penalizuje, protože efektivní útok vyžaduje, aby jeden král mohl obejít druhého.
- **Horní extrém ($dist > 6$):** Pokud jsou od sebe přes celou desku, nemohou vytvořit síť. Soupeř snadno proklouzne mezi nimi.
- **Optimum ($dist \in [2,4]$):** "Sweet spot". Králové jsou dost blízko na podporu, ale dost daleko na to, aby pokryli šířku desky.


#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_coordination" dedent="true"}
```

1. Bonus za koordinaci králů ve vzdálenosti 2–6 polí.
2. Squeeze — sevření soupeře, bonus roste s blízkostí.

### 4. Past a Síť (Net Formation)

#### Požadavek
Vytvořit formaci, ze které není úniku.

#### Diskuze
Toto je nejpokročilejší část heuristiky. Detekujeme, který král je blíže k rohu ("Kotva") a od druhého ("Operátor") vyžadujeme, aby se pohyboval po diagonále **směrem od rohu**, čímž uzavírá síť. Bez této složky by agent soupeře jen "honil" kolem dokola.

#### Geometrická definice
Síť je definována vektorem mezi Kotvou ($K_A$) a Operátorem ($K_O$).
- **Podmínka:** $K_O$ musí ležet na diagonále $d$, která je kolmá na spojnici $K_A \to Roh$.
- **Extrém:** Pokud se $K_O$ přiblíží k rohu ($dist(K_O, Roh) \to 0$), síť kolabuje ("Crowding").
- **Cíl:** Maximalizovat $dist(K_O, Roh)$ při zachování diagonální vazby. Tím se síť roztahuje a vytlačuje soupeře.


#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_net" dedent="true"}
```

1. Net bonus: Operátor na správné diagonále.
2. Crowding penalta: Operátor příliš blízko rohu.

### 5. Prevence patu a ústupu (Retreat Penalty)

#### Požadavek
Hra musí konvergovat k cíli. Nesmíme dovolit nekonečné manévrování.

#### Diskuze
Občas se stane, že AI "nevidí" cestu k výhře v rámci horizontu (depth limit) a rozhodne se "čekat" (ustoupit). Abychom tomu předešli, penalizujeme stavy, kde se průměrná vzdálenost k soupeři zvyšuje.

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_retreat" dedent="true"}
```

1. Tvrdá penalta za velkou průměrnou vzdálenost — promarněná příležitost.
2. Střední penalta za mírné oddálení.
3. Penalta za nejbližšího krále stále daleko.

***

## Analýza Výsledků a Parametry

Následující tabulka shrnuje váhy použité ve finální verzi heuristiky (`perfect_endgame_heuristic`). Tyto hodnoty byly laděny pomocí ablačních studií.

```julia
#| label: tbl-params
#| tbl-cap: "Parametry heuristické funkce (načteno z kódu)"
#| output: asis

include("/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl")
using Markdown

# Vytvoření tabulky z konstanty PERFECT_WEIGHTS
key_map = Dict(
    :MATERIAL => "Materiál (Základ)",
    :WIN => "Výhra (Infinity)",
    :SAFETY_RED => "Penalta: Červený v bezpečí",
    :ACTIVE_RED => "Bonus: Červený aktivní",
    :COORD => "Koordinace králů",
    :SQUEEZE => "Sevření (Squeeze)",
    :RETREAT_MAX => "Penalta: Ústup (Max)",
    :NET => "Past (Net Formation)",
    :CROWDING => "Přeplnění (Crowding)",
    :MOBILITY => "Mobilita soupeře"
)

println("| Komponenta | Váha | Význam |")
println("|---|---|---|")
for (k, desc) in sort(collect(key_map), by=x->string(x[1]))
    val = PERFECT_WEIGHTS[k]
    println("| **$desc** | `$val` | Koeficient v lineární kombinaci |")
end
```

### Pozorování: Horizont Efekt

Při hloubce prohledávání 6 (3 tahy každého) se stále setkáváme s "Horizont efektem". Agent může odsunout nevyhnutelnou prohru o tah dál, i když to z dlouhodobého hlediska nic neřeší. 

> **Řešení**: Zavedení "pseudo-terminálních" stavů (např. penalizace za ústup), které heuristicky simulují "blížící se konec", i když není přímo vidět ve stromu.

***

## Průběh hry (Manuální analýza)

Následující sekvence snímků (z Excalidraw) vizuálně demonstruje úspěšné uplatnění výše popsaných principů v praxi.

<!--
::: {#fig-game-phases layout-ncol=2}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=6plydeepbutstillstarting|Fáze 1 - Horizont efekt - AI vidí hrozbu, ale je těsně za horizontem.]]{#fig-phase1}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=safecornerblock|Fáze 2a - Safe Corner Block - Úspěšné zablokování úniku.]]{#fig-phase2a}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=doublecornerblunder|Fáze 2b - Ukázka chyby (Blunder) - Červený uniká.]]{#fig-phase2b}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=decisivemoment1|Fáze 3 - Vytlačení z rohu (Pushing).]]{#fig-phase3}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=expected-optimal-ply1|Fáze 4 - Formování pasti (Net building) - Kotva a Operátor.]]{#fig-phase4}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=needlesstodivedeeper|Fáze 5 - Vynucené tahy (Forced Moves).]]{#fig-phase5}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=insta-lost|Fáze 6 - Finální past (Impossible to escape).]]{#fig-phase6}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=forcedending|Fáze 7 - Vynucený konec (Forced Ending).]]{#fig-phase7}

Manuální analýza klíčových fází hry
:::
-->

> **Poznámka:** Vizuální analýza fází hry (exporty z Excalidraw) není v této verzi dokumentu k dispozici. Odkazujeme na zdrojové soubory v repozitáři.

***


***

## Případová studie: Rozhodování v Hloubce 6

Během ladění heuristiky jsme narazili na kritickou situaci, kde AI v hloubce 6 (3 tahy každého) váhala mezi dvěma tahy. Tato situace krásně ilustruje, jak jemné změny v definici metriky ovlivňují chování agenta.

**Konflikt:**
- **Optimální tah (14-9)**: Vede přímo k obsazení klíčového bodu pro sestrojení pasti.
- **Suboptimální tah (10-7)**: Vypadá bezpečně a udržuje vzdálenost, ale v reálu ztrácí tempo a dává soupeři šanci uniknout.

Původní heuristika ohodnotila oba tahy téměř stejně. Důvodem byla **Manhattanská vzdálenost**, která v dámě (kde se chodí po diagonálách) měřila vzdálenost $\Delta x + \Delta y$ nepřesně. Pro krále jsou pole 9 a 2 topologicky stejně vzdálená (Vzdálenost 2), i když pole 9 je strategicky mnohem cennější.

**Řešení:**
Přechod na **Čebyševovu vzdálenost** ($\max(|\Delta x|, |\Delta y|)$). Tato metrika správně identifikovala, že pole 5 (cíl) je z pole 9 dosažitelné za 1 krok (Vzdálenost 1), zatímco z pole 2 je to stále daleko.

**Výsledek po úpravě:**
- **Optimální tah (14-9)**: Skóre **4160.0** (Aktivní bonus za přiblížení).
- **Suboptimální tah (10-7)**: Skóre **3670.0** (Bez bonusu).
- **Rozdíl**: **+490.0** bodů jasně preferuje vítěznou variantu.

Tato změna umožnila agentovi najít vítěznou sekvenci: `14-9` $\to$ `1-5` $\to$ `10-14` $\to$ `5-1` $\to$ `9-5` $\to$ `1-6` $\to$ `5-1` $\to$ `6-2` $\to$ `14-18`.

***

### Co si z toho odnést?
Jakmile se podaří sestavit tu past ("síť"), je dobojováno. Heuristika pak dává tak jasná čísla, že Alpha-Beta ořeže skoro všechno a agent hraje bleskově. Ten pocit, když to konečně začalo fungovat a viděl jsem, jak červený král marně hledá únik, byl k nezaplacení.
