---
title: ""
aliases: []
id: alphabeta-sim-tros01
tags: []
format:
  pdf:
    colorlinks: true
    header-includes:
      - '\usepackage{caption}'
    include-before-body: "titlepage.tex"
    number-sections: true
    toc: true
execute:
  echo: false
  warning: false
jupyter: julia-1.12
---
{{<pagebreak>}}

# Manuální dohrání a Analýza koncovky

Tato kapitola dokumentuje vývoj a ladění heuristické funkce pro koncovku **2 králové proti 1 králi**. Cílem bylo vytvořit agenta, který dokáže spolehlivě a efektivně (v minimálním počtu tahů) zvítězit proti optimálně hrajícímu soupeři.

**Vizualizace herního stromu (Obrázek `\ref{fig-assignment}`{=latex} na titulní straně)**

Obrázek na úvodní stránce ilustruje princip prohledávání herního prostoru pomocí algoritmu Minimax s Alpha-Beta ořezáváním:
- **MAX uzly (Zelené/Fialové)**: Stavy, kde maximalizujeme naše skóre.
- **MIN uzly (Červené/Azurové)**: Stavy, kde soupeř minimalizuje naše skóre.
- **Ořezávání (Pruning)**: Šedé větve nebyly prozkoumány, protože algoritmus matematicky dokázal, že nemohou vylepšit výsledek.

## Klíčové momenty a Strategie

V této sekci konsolidujeme uživatelské požadavky a pozorování z průběhu vývoje. Pro úspěšné dohrání partie je nutné pochopit dynamiku koncovky.

### Strategické imperativy

1.  **Zachování přesily (2:1)**: Absolutní prioritou je nedostat se do situace 1:1. Výměna krále za krále vede okamžitě k remíze.
2.  **Vytlačení z centra**: Soupeřův král se snaží držet v centru (nejsilnější pozice). Naším cílem je vytlačit ho na okraj.
3.  **Past (The Net)**: Samotné zatlačení nestačí. Je nutné vytvořit kooperativní formaci ("síť"), která soupeři postupně odebere všechny bezpečné tahy.

### Role králů: Kotva a Operátor

Během analýzy jsme identifikovali dělbu rolí mezi našimi králi, kterou heuristika musí podporovat:
-   **Kotva (Anchor)**: Drží klíčovou pozici (obvykle u rohu) a omezuje únikové cesty soupeře. Je statický.
-   **Operátor (Operator)**: Aktivně manévruje, zmenšuje prostor a připravuje finální útok.

***

## Detailní rozbor heuristiky (Periodic Blocks)

V této části rozebíráme jednotlivé komponenty hodnotící funkce. Každá komponenta je prezentována ve struktuře: **Požadavek $\to$ Diskuze $\to$ Matematika $\to$ Implementace**.

### 1. Materiál a Bezpečnost (1v1 Protection)

#### Požadavek
Zabránit za každou cenu výměně, která by vedla k remíze (1 vs 1).

#### Diskuze
V běžné střední hře je výměna 1:1 přijatelná. V koncovce 2:1 je to fatální chyba. Heuristika musí vnímat stav 1:1 jako "zakázaný" (loss condition).

#### Matematika
$$
h_{material} = \begin{cases} 
-\infty & \text{pokud } N_{my}=1 \land N_{opp}=1 \\
w_{mat} \cdot (N_{my} - N_{opp}) & \text{jinak}
\end{cases}
$$

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_1v1" dedent="true"}
```

### 2. Pozice a Kontrola (Red Position)

#### Požadavek
Donutit soupeře opustit bezpečné "dvojité rohy" (pole 1, 5, 28, 32).

#### Diskuze
Červený král v rohu je v bezpečí. Nemůžeme ho vyhodit, pokud neudělá chybu. Musíme ho aktivně "vytlačit" nebo "vykouřit" tím, že mu obsadíme sousední pole a donutíme ho k tahu (tzv. *zugzwang*).

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_red_pos" dedent="true"}
```

### 3. Koordinace (Coordination & Squeeze)

#### Požadavek
Králové musí spolupracovat. Jeden sám nic nezmůže.

#### Diskuze
Zavedli jsme koncept "optimální vzdálenosti". Pokud jsou naši králové příliš daleko od sebe (>6 polí), nemohou si krýt záda. Pokud jsou příliš blízko (1 pole), překážejí si. Ideální vzdálenost je 2-4 pole.

#### Matematika
Heuristika uděluje bonus $w_{coord}$, pokud:
$$ 2 \le dist(K_1, K_2) \le 4 $$

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_coordination" dedent="true"}
```

### 4. Past a Síť (Net Formation)

#### Požadavek
Vytvořit formaci, ze které není úniku.

#### Diskuze
Toto je nejpokročilejší část heuristiky. Detekujeme, který král je blíže k rohu ("Kotva") a od druhého ("Operátor") vyžadujeme, aby se pohyboval po diagonále **směrem od rohu**, čímž uzavírá síť. Bez této složky by agent soupeře jen "honil" kolem dokola.

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_net" dedent="true"}
```

### 5. Prevence patu a ústupu (Retreat Penalty)

#### Požadavek
Hra musí konvergovat k cíli. Nesmíme dovolit nekonečné manévrování.

#### Diskuze
Občas se stane, že AI "nevidí" cestu k výhře v rámci horizontu (depth limit) a rozhodne se "čekat" (ustoupit). Abychom tomu předešli, penalizujeme stavy, kde se průměrná vzdálenost k soupeři zvyšuje.

#### Implementace
```{.julia include="/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl" region="perfect_retreat" dedent="true"}
```

***

## Analýza Výsledků a Parametry

Následující tabulka shrnuje váhy použité ve finální verzi heuristiky (`perfect_endgame_heuristic`). Tyto hodnoty byly laděny pomocí ablačních studií.

```julia
#| label: tbl-params
#| tbl-cap: "Parametry heuristické funkce (načteno z kódu)"
#| output: asis

include("/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/2..simulace/src/heuristics.jl")
using Markdown

# Vytvoření tabulky z konstanty PERFECT_WEIGHTS
key_map = Dict(
    :MATERIAL => "Materiál (Základ)",
    :WIN => "Výhra (Infinity)",
    :SAFETY_RED => "Penalta: Červený v bezpečí",
    :ACTIVE_RED => "Bonus: Červený aktivní",
    :COORD => "Koordinace králů",
    :SQUEEZE => "Sevření (Squeeze)",
    :RETREAT_MAX => "Penalta: Ústup (Max)",
    :NET => "Past (Net Formation)",
    :CROWDING => "Přeplnění (Crowding)",
    :MOBILITY => "Mobilita soupeře"
)

println("| Komponenta | Váha | Význam |")
println("|---|---|---|")
for (k, desc) in sort(collect(key_map), by=x->string(x[1]))
    val = PERFECT_WEIGHTS[k]
    println("| **$desc** | `$val` | Koeficient v lineární kombinaci |")
end
```

### Pozorování: Horizont Efekt

Při hloubce prohledávání 6 (3 tahy každého) se stále setkáváme s "Horizont efektem". Agent může odsunout nevyhnutelnou prohru o tah dál, i když to z dlouhodobého hlediska nic neřeší. 

> **Řešení**: Zavedení "pseudo-terminálních" stavů (např. penalizace za ústup), které heuristicky simulují "blížící se konec", i když není přímo vidět ve stromu.

***

## Průběh hry (Manuální analýza)

Následující sekvence snímků (z Excalidraw) vizuálně demonstruje úspěšné uplatnění výše popsaných principů v praxi.

::: {#fig-game-phases layout-ncol=2}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=6plydeepbutstillstarting|Fáze 1 - Horizont efekt - AI vidí hrozbu, ale je těsně za horizontem.]]{#fig-phase1}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=safecornerblock|Fáze 2a - Safe Corner Block - Úspěšné zablokování úniku.]]{#fig-phase2a}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=doublecornerblunder|Fáze 2b - Ukázka chyby (Blunder) - Červený uniká.]]{#fig-phase2b}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=decisivemoment1|Fáze 3 - Vytlačení z rohu (Pushing).]]{#fig-phase3}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=expected-optimal-ply1|Fáze 4 - Formování pasti (Net building) - Kotva a Operátor.]]{#fig-phase4}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=needlesstodivedeeper|Fáze 5 - Vynucené tahy (Forced Moves).]]{#fig-phase5}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=insta-lost|Fáze 6 - Finální past (Impossible to escape).]]{#fig-phase6}

![[/home/sim/Obsi/Prods/04-škola/Předměty/mgr3/4IZ431..AI1/Zpracováno/ang-dama-tros01/1..dohrání/minimaxalphabeta-assignment.excalidraw.md#^frame=forcedending|Fáze 7 - Vynucený konec (Forced Ending).]]{#fig-phase7}

Manuální analýza klíčových fází hry
:::


***

## Případová studie: Rozhodování v Hloubce 6

Během ladění heuristiky jsme narazili na kritickou situaci, kde AI v hloubce 6 (3 tahy každého) váhala mezi dvěma tahy. Tato situace krásně ilustruje, jak jemné změny v definici metriky ovlivňují chování agenta.

**Konflikt:**
- **Optimální tah (14-9)**: Vede přímo k obsazení klíčového bodu pro sestrojení pasti.
- **Suboptimální tah (10-7)**: Vypadá bezpečně a udržuje vzdálenost, ale v reálu ztrácí tempo a dává soupeři šanci uniknout.

Původní heuristika ohodnotila oba tahy téměř stejně. Důvodem byla **Manhattanská vzdálenost**, která v dámě (kde se chodí po diagonálách) měřila vzdálenost $\Delta x + \Delta y$ nepřesně. Pro krále jsou pole 9 a 2 topologicky stejně vzdálená (Vzdálenost 2), i když pole 9 je strategicky mnohem cennější.

**Řešení:**
Přechod na **Čebyševovu vzdálenost** ($\max(|\Delta x|, |\Delta y|)$). Tato metrika správně identifikovala, že pole 5 (cíl) je z pole 9 dosažitelné za 1 krok (Vzdálenost 1), zatímco z pole 2 je to stále daleko.

**Výsledek po úpravě:**
- **Optimální tah (14-9)**: Skóre **4160.0** (Aktivní bonus za přiblížení).
- **Suboptimální tah (10-7)**: Skóre **3670.0** (Bez bonusu).
- **Rozdíl**: **+490.0** bodů jasně preferuje vítěznou variantu.

Tato změna umožnila agentovi najít vítěznou sekvenci: `14-9` $\to$ `1-5` $\to$ `10-14` $\to$ `5-1` $\to$ `9-5` $\to$ `1-6` $\to$ `5-1` $\to$ `6-2` $\to$ `14-18`.

***

### Závěr k analýze
Jak vidíme na obrázcích @fig-phase4 až @fig-phase7, jakmile se podaří sestavit "síť" (princip #4), hra přechází do deterministické fáze. Heuristika v této chvíli dává tak vysoké skóre, že Alpha-Beta ořezávání eliminuje téměř všechny ostatní větve a agent hraje prakticky okamžitě.
